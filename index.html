<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BlackBox Mini - Dashboard</title>
<style>
:root{--bg:#0f172a;--card:#1e293b;--txt:#e5e7eb;--muted:#94a3b8;--accent:#38bdf8}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--txt)}
header{background:var(--card);padding:12px;text-align:center;font-size:20px;font-weight:700;color:var(--accent)}
main{padding:16px;max-width:1000px;margin:0 auto}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
.card{background:var(--card);padding:12px;border-radius:10px;display:flex;flex-direction:column;gap:8px}
.label{color:var(--muted);font-size:13px}.valor{color:var(--accent);font-weight:700;font-size:18px}
.controls{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap}
button,input{padding:10px;border-radius:8px;border:none;font-size:14px}
button{background:var(--accent);color:#002233;cursor:pointer}
.small{color:var(--muted);font-size:13px}
.footer{margin-top:14px;color:var(--muted);text-align:center}
.badge{display:inline-block;background:#0b1220;border:1px solid #22314d;color:var(--muted);padding:4px 8px;border-radius:999px;font-size:12px}
.row{display:flex;gap:8px;flex-wrap:wrap}
.status{font-size:13px;color:var(--muted)}
hr{border:0;border-top:1px solid #22314d;margin:10px 0}
</style>
</head>
<body>
<header>ðŸ“Š BlackBox Mini â€” Dashboard</header>
<main>

  <!-- CONEXÃƒO -->
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div>
        <strong>ConexÃ£o</strong>
        <div class="small">BLE recomendado (HTTPS). HTTP como fallback.</div>
        <div id="connStatus" class="status">Aguardandoâ€¦</div>
      </div>
      <div class="row">
        <button id="btnBle">Conectar via BLE</button>
        <button id="btnDisconnect" disabled>Desconectar</button>
      </div>
    </div>

    <hr>

    <div class="row">
      <input id="ipField" placeholder="Fallback HTTP IP (ex.: 192.168.4.1)" style="flex:1;min-width:240px">
      <button id="btnHttp">Conectar HTTP</button>
      <span class="badge" id="httpInfo">HTTPS bloqueia chamadas HTTP â€” use BLE no Pages</span>
    </div>

    <div class="row">
      <input id="idField" placeholder="ID do dispositivo (para buscar IP na nuvem)" style="flex:1;min-width:240px">
      <button id="btnFromCloud">Ir via nuvem (pegar IP e redirecionar)</button>
    </div>
    <div class="small" id="cloudNote">Defina sua URL de nuvem no cÃ³digo (CLOUD_BASE).</div>
  </div>

  <h2 style="color:var(--accent);margin-top:12px">MediÃ§Ãµes (tempo real)</h2>
  <div class="grid" id="cards">
    <div class="card"><div class="label">TensÃ£o RMS</div><div class="valor" id="v">--</div></div>
    <div class="card"><div class="label">Corrente RMS</div><div class="valor" id="i">--</div></div>
    <div class="card"><div class="label">Fator de PotÃªncia</div><div class="valor" id="fp">--</div></div>
    <div class="card"><div class="label">Ã‚ngulo Ï†</div><div class="valor" id="angle">--</div></div>
    <div class="card"><div class="label">THD TensÃ£o</div><div class="valor" id="thd">--</div></div>
    <div class="card"><div class="label">THD Corrente</div><div class="valor" id="thd_i">--</div></div>
    <div class="card"><div class="label">FrequÃªncia</div><div class="valor" id="f">--</div></div>
    <div class="card"><div class="label">HarmÃ´nico 3Âª</div><div class="valor" id="h3">--</div></div>
    <div class="card"><div class="label">HarmÃ´nico 5Âª</div><div class="valor" id="h5">--</div></div>
    <div class="card"><div class="label">HarmÃ´nico 7Âª</div><div class="valor" id="h7">--</div></div>
  </div>

  <div class="card" style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
    <div>
      <div class="small">Ãšltima atualizaÃ§Ã£o:</div>
      <div id="last" class="small">--</div>
    </div>
    <div class="row">
      <button id="btnSaveCloud">Salvar no servidor (empresa)</button>
    </div>
  </div>

  <div class="footer small">Nada Ã© salvo localmente. Use BLE no GitHub Pages; HTTP funciona quando a pÃ¡gina Ã© aberta em HTTP.</div>
</main>

<script>
/* ===================== CONFIG ===================== */
/* UUIDs alinhados com o firmware atualizado */
const SERVICE_UUID    = '12345678-1234-1234-1234-1234567890ab';
const DATA_CHAR_UUID  = 'fedcba98-7654-4321-aaaa-bbbbbbbbbbbb'; // <- mesma do firmware

/* Backend para buscar IP por ID (ex.: Firebase REST) */
const CLOUD_BASE = 'https://SEU_FIREBASE.firebaseio.com/devices'; // troque pelo seu endpoint

/* ===================== UI/STATE ===================== */
const el = (id)=>document.getElementById(id);
const btnBle = el('btnBle');
const btnDisconnect = el('btnDisconnect');
const btnHttp = el('btnHttp');
const btnFromCloud = el('btnFromCloud');
const ipField = el('ipField');
const idField = el('idField');
const lastEl = el('last');
const connStatus = el('connStatus');
const httpInfo = el('httpInfo');
const btnSaveCloud = el('btnSaveCloud');

let bleDevice = null;
let bleChar = null;
let httpTimer = null;

/* ===================== HELPERS ===================== */
function setStatus(s){ connStatus.textContent = s; }
function updateValues(j){
  if (!j) return;
  if (typeof j.v === 'number')   el('v').textContent     = j.v.toFixed(2);
  if (typeof j.i === 'number')   el('i').textContent     = j.i.toFixed(2);
  if (typeof j.fp === 'number')  el('fp').textContent    = j.fp.toFixed(3);
  if (typeof j.angle === 'number') el('angle').textContent = j.angle.toFixed(1);
  if (typeof j.thd === 'number') el('thd').textContent   = j.thd.toFixed(2);
  if (typeof j.thd_i === 'number') el('thd_i').textContent = j.thd_i.toFixed(2);
  if (typeof j.f === 'number')   el('f').textContent     = j.f.toFixed(2);
  if (typeof j.h3 === 'number')  el('h3').textContent    = j.h3.toFixed(2);
  if (typeof j.h5 === 'number')  el('h5').textContent    = j.h5.toFixed(2);
  if (typeof j.h7 === 'number')  el('h7').textContent    = j.h7.toFixed(2);
  lastEl.textContent = new Date().toLocaleTimeString();
}

/* ===================== BLE ===================== */
async function connectBLE(){
  if(!navigator.bluetooth){ alert('Web Bluetooth nÃ£o disponÃ­vel neste navegador.'); return; }
  btnBle.disabled = true;
  try{
    setStatus('Procurando dispositivo BLEâ€¦');
    const device = await navigator.bluetooth.requestDevice({
      filters:[{ name: 'MiniSlaveV1' }],
      optionalServices:[SERVICE_UUID]
    });
    bleDevice = device;
    device.addEventListener('gattserverdisconnected', onBleDisconnect);

    const server = await device.gatt.connect();
    const svc = await server.getPrimaryService(SERVICE_UUID);
    const chr = await svc.getCharacteristic(DATA_CHAR_UUID);
    bleChar = chr;

    if (chr.properties.notify) {
      await chr.startNotifications();
      chr.addEventListener('characteristicvaluechanged', e=>{
        const value = new TextDecoder().decode(e.target.value);
        try { updateValues(JSON.parse(value)); }
        catch(err){ console.warn('BLE JSON invÃ¡lido', err, value); }
      });
      btnDisconnect.disabled = true === false ? false : false; // mantÃ©m habilitado
      btnDisconnect.disabled = false;
      btnBle.textContent = 'Conectado (BLE)';
      setStatus('Conectado via BLE.');
    } else {
      const v = await chr.readValue();
      try { updateValues(JSON.parse(new TextDecoder().decode(v))); } catch{}
      setStatus('Conectado (BLE, leitura Ãºnica).');
    }
  }catch(err){
    console.error(err);
    alert('Erro BLE: '+err);
    setStatus('Falha no BLE.');
  }finally{
    btnBle.disabled = false;
  }
}

function onBleDisconnect(){
  btnBle.textContent = 'Conectar via BLE';
  btnDisconnect.disabled = true;
  setStatus('BLE desconectado.');
  bleDevice = null; bleChar = null;
}

btnBle.addEventListener('click', connectBLE);
btnDisconnect.addEventListener('click', ()=>{
  if (bleDevice && bleDevice.gatt.connected) bleDevice.gatt.disconnect();
  onBleDisconnect();
});

/* ===================== HTTP (fallback) ===================== */
async function connectHTTPOnce(ip){
  try{
    const base = ip.startsWith('http') ? ip : 'http://' + ip;
    const r = await fetch(base + '/data', {cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const j = await r.json();
    updateValues(j);
    setStatus('Conectado via HTTP: '+base);
    return true;
  }catch(err){
    console.warn('HTTP falhou', err);
    setStatus('HTTP falhou. Verifique IP ou use BLE.');
    return false;
  }
}

btnHttp.addEventListener('click', ()=>{
  const ip = ipField.value.trim();
  if(!ip){ alert('Digite o IP (ex.: 192.168.4.1)'); return; }
  if (httpTimer) clearInterval(httpTimer);
  connectHTTPOnce(ip);
  httpTimer = setInterval(()=>connectHTTPOnce(ip), 1000);
});

/* HTTPS bloqueia chamadas HTTP em background (mixed content) â€” redirecionar para http://IP funciona */
if (location.protocol === 'https:') httpInfo.style.display = 'inline-block';

/* ===================== CLOUD LOOKUP (ID -> IP) ===================== */
async function resolveIpFromCloud(id){
  const url = `${CLOUD_BASE}/${encodeURIComponent(id)}.json`;
  const r = await fetch(url, {cache:'no-store'});
  if(!r.ok) throw new Error('Cloud HTTP '+r.status);
  const j = await r.json();
  if(!j || !j.ip) throw new Error('ID nÃ£o encontrado na nuvem');
  return j.ip;
}

btnFromCloud.addEventListener('click', async ()=>{
  const id = idField.value.trim();
  if(!id){ alert('Informe o ID do dispositivo'); return; }
  setStatus('Buscando IP na nuvemâ€¦');
  try{
    const ip = await resolveIpFromCloud(id);
    setStatus(`Redirecionando para http://${ip} â€¦`);
    // redirecionar (sai do HTTPS, entÃ£o nÃ£o tem mixed content)
    location.href = `http://${ip}`;
  }catch(err){
    console.error(err);
    setStatus('Falha ao buscar IP na nuvem.');
    alert('Erro: '+err.message);
  }
});

/* ===================== SALVAR NA NUVEM (opcional, sÃ³ por clique) ===================== */
btnSaveCloud.addEventListener('click', ()=>{
  const params = new URLSearchParams();
  params.set('device','MiniSlaveV1');
  try{
    params.set('v',  el('v').textContent);
    params.set('i',  el('i').textContent);
    params.set('fp', el('fp').textContent);
  }catch{}
  const url = 'https://empresa.exemplo.com/save?'+params.toString(); // TROCAR para seu servidor
  window.open(url, '_blank');
});

/* ===================== AUTO-MODE via querystring ===================== */
/* Suporta:
   ?ip=192.168.0.123        -> inicia HTTP polling
   ?id=abc123               -> busca IP na nuvem e REDIRECIONA p/ http://IP
   ?mode=ble                -> apenas mostra dica para clicar no BLE (auto-conectar nÃ£o Ã© permitido pelo browser)
*/
(function autoFromQuery(){
  const q = new URLSearchParams(location.search);
  const ip = q.get('ip');
  const id = q.get('id');
  const mode = q.get('mode');

  if (id) {
    idField.value = id;
    // Busca IP e redireciona automaticamente
    btnFromCloud.click();
    return;
  }

  if (ip) {
    ipField.value = ip;
    btnHttp.click();
    return;
  }

  if (mode === 'ble') {
    setStatus('Clique em "Conectar via BLE" (requer gesto do usuÃ¡rio).');
  }
})();

/* limpeza */
window.addEventListener('beforeunload', ()=>{
  if (httpTimer) clearInterval(httpTimer);
  try { if (bleChar && bleChar.properties?.notify) bleChar.stopNotifications(); } catch {}
});
</script>
</body>
</html>

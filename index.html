<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BlackBox Mini - Dashboard (BLE)</title>
<style>
:root{--bg:#0f172a;--card:#1e293b;--txt:#e5e7eb;--muted:#94a3b8;--accent:#38bdf8}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--txt)}
header{background:var(--card);padding:12px;text-align:center;font-size:20px;font-weight:700;color:var(--accent)}
main{padding:16px;max-width:960px;margin:0 auto}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
.card{background:var(--card);padding:12px;border-radius:10px;display:flex;flex-direction:column;gap:8px}
.label{color:var(--muted);font-size:13px}.valor{color:var(--accent);font-weight:700;font-size:18px}
.controls{display:flex;gap:8px;margin:10px 0}
button,input{padding:10px;border-radius:8px;border:none;font-size:14px}
button{background:var(--accent);color:#002233;cursor:pointer}
.small{color:var(--muted);font-size:13px}
.footer{margin-top:14px;color:var(--muted);text-align:center}
</style>
</head>
<body>
<header>ðŸ“Š BlackBox Mini â€” Dashboard</header>
<main>
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <strong>ConexÃ£o</strong>
        <div class="small">Use BLE (recomendado) ou fallback HTTP</div>
      </div>
      <div style="display:flex;gap:8px">
        <button id="btnBle">Conectar via BLE</button>
        <button id="btnDisconnect" disabled>Desconectar</button>
      </div>
    </div>

    <div style="margin-top:10px;">
      <div style="display:flex;gap:8px">
        <input id="ipField" placeholder="Fallback HTTP IP (apenas se pÃ¡gina em HTTP)" style="flex:1">
        <button id="btnHttp">Conectar HTTP</button>
      </div>
      <div class="small" style="margin-top:6px">Nota: se a pÃ¡gina estiver em <strong>HTTPS</strong> (GitHub Pages), chamadas HTTP locais sÃ£o bloqueadas pelo navegador. Use BLE.</div>
    </div>
  </div>

  <h2 style="color:var(--accent);margin-top:12px">MediÃ§Ãµes (tempo real)</h2>
  <div class="grid" id="cards">
    <div class="card"><div class="label">TensÃ£o RMS</div><div class="valor" id="v">--</div></div>
    <div class="card"><div class="label">Corrente RMS</div><div class="valor" id="i">--</div></div>
    <div class="card"><div class="label">Fator de PotÃªncia</div><div class="valor" id="fp">--</div></div>
    <div class="card"><div class="label">Ã‚ngulo Ï†</div><div class="valor" id="angle">--</div></div>
    <div class="card"><div class="label">THD TensÃ£o</div><div class="valor" id="thd">--</div></div>
    <div class="card"><div class="label">THD Corrente</div><div class="valor" id="thd_i">--</div></div>
    <div class="card"><div class="label">FrequÃªncia</div><div class="valor" id="f">--</div></div>
    <div class="card"><div class="label">HarmÃ´nico 3Âª</div><div class="valor" id="h3">--</div></div>
    <div class="card"><div class="label">HarmÃ´nico 5Âª</div><div class="valor" id="h5">--</div></div>
    <div class="card"><div class="label">HarmÃ´nico 7Âª</div><div class="valor" id="h7">--</div></div>
  </div>

  <div class="card" style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
    <div>
      <div class="small">Ãšltima atualizaÃ§Ã£o:</div>
      <div id="last" class="small">--</div>
    </div>
    <div style="display:flex;gap:8px">
      <!-- botÃ£o que abre servidor da empresa (sÃ³ quando o usuÃ¡rio clicar) -->
      <button id="btnSaveCloud">Salvar no servidor (empresa)</button>
    </div>
  </div>

  <div class="footer small">ConexÃ£o via BLE Ã© recomendada para funcionamento sem configuraÃ§Ã£o. Nada Ã© salvo localmente.</div>
</main>

<script>
/*
  EstratÃ©gia:
  - Tenta conectar por BLE (recomendado). Espera notifications com JSON.
  - Se BLE nÃ£o for possÃ­vel, o usuÃ¡rio pode usar fallback HTTP (IP manual).
  - A interface NÃƒO grava nada automaticamente. Somente quando usuÃ¡rio clicar "Salvar no servidor"
    abrimos uma nova aba com o endereÃ§o do servidor da empresa (GET com parÃ¢metros mÃ­nimos).
*/

/* UUIDs â€” ajuste se mudar no firmware */
const SERVICE_UUID = '12345678-1234-1234-1234-1234567890ab'; // serviÃ§o exemplo
const DATA_CHAR_UUID = 'fedcba98-1234-5678-1234-abcdefabcdef'; // caracterÃ­stica notificaÃ§Ã£o (telemetria)

// elementos UI
const btnBle = document.getElementById('btnBle');
const btnDisconnect = document.getElementById('btnDisconnect');
const btnHttp = document.getElementById('btnHttp');
const ipField = document.getElementById('ipField');
const btnSaveCloud = document.getElementById('btnSaveCloud');
const lastEl = document.getElementById('last');

let bleDevice = null;
let bleChar = null;
let httpTimer = null;

// atualiza UI com objeto JSON
function updateValues(j) {
  if (!j) return;
  if (typeof j.v === 'number') document.getElementById('v').textContent = j.v.toFixed(2);
  if (typeof j.i === 'number') document.getElementById('i').textContent = j.i.toFixed(2);
  if (typeof j.fp === 'number') document.getElementById('fp').textContent = j.fp.toFixed(3);
  if (typeof j.angle === 'number') document.getElementById('angle').textContent = j.angle.toFixed(1);
  if (typeof j.thd === 'number') document.getElementById('thd').textContent = j.thd.toFixed(2);
  if (typeof j.thd_i === 'number') document.getElementById('thd_i').textContent = j.thd_i.toFixed(2);
  if (typeof j.f === 'number') document.getElementById('f').textContent = j.f.toFixed(2);
  if (typeof j.h3 === 'number') document.getElementById('h3').textContent = j.h3.toFixed(2);
  if (typeof j.h5 === 'number') document.getElementById('h5').textContent = j.h5.toFixed(2);
  if (typeof j.h7 === 'number') document.getElementById('h7').textContent = j.h7.toFixed(2);
  lastEl.textContent = new Date().toLocaleTimeString();
}

/* ------- BLE ------- */
async function connectBLE() {
  if (!navigator.bluetooth) {
    alert('Web Bluetooth nÃ£o disponÃ­vel neste navegador.');
    return;
  }
  try {
    btnBle.disabled = true;
    const device = await navigator.bluetooth.requestDevice({
      filters: [{ name: 'MiniSlaveV1' }], // ou use services: [SERVICE_UUID]
      optionalServices: [SERVICE_UUID]
    });
    bleDevice = device;
    device.addEventListener('gattserverdisconnected', onBleDisconnect);

    const server = await device.gatt.connect();
    const svc = await server.getPrimaryService(SERVICE_UUID);
    const chr = await svc.getCharacteristic(DATA_CHAR_UUID);
    bleChar = chr;

    // se suportar notificaÃ§Ãµes
    if (chr.properties.notify) {
      await chr.startNotifications();
      chr.addEventListener('characteristicvaluechanged', e => {
        const value = new TextDecoder().decode(e.target.value);
        try {
          const j = JSON.parse(value);
          updateValues(j);
        } catch (err) { console.warn('BLE JSON parse failed', err, value); }
      });
      btnDisconnect.disabled = false;
      btnBle.textContent = 'Conectado (BLE)';
    } else {
      // se caracterÃ­stica for apenas leitura
      const v = await chr.readValue();
      const s = new TextDecoder().decode(v);
      try { updateValues(JSON.parse(s)); } catch {}
    }
  } catch (err) {
    console.error(err);
    alert('Erro BLE: ' + err);
  } finally {
    btnBle.disabled = false;
  }
}

function onBleDisconnect() {
  btnBle.textContent = 'Conectar via BLE';
  btnDisconnect.disabled = true;
  bleDevice = null;
  bleChar = null;
}

/* botÃ£o desconectar */
btnDisconnect.addEventListener('click', () => {
  if (bleDevice && bleDevice.gatt.connected) bleDevice.gatt.disconnect();
  onBleDisconnect();
});

/* liga botÃ£o BLE */
btnBle.addEventListener('click', connectBLE);

/* ------- HTTP fallback (polling) ------- */
async function connectHTTPOnce(ip) {
  try {
    const resp = await fetch((ip.startsWith('http')? ip: 'http://' + ip) + '/data', { cache: 'no-store' });
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const j = await resp.json();
    updateValues(j);
    return true;
  } catch (err) {
    console.warn('HTTP fetch failed', err);
    return false;
  }
}

btnHttp.addEventListener('click', () => {
  const ip = ipField.value.trim();
  if (!ip) { alert('Digite o IP do ESP (ex: 192.168.4.1)'); return; }
  if (httpTimer) clearInterval(httpTimer);
  // Poll a cada 1s
  connectHTTPOnce(ip);
  httpTimer = setInterval(() => connectHTTPOnce(ip), 1000);
});

/* ------- Save to cloud (only on user click) ------- */
btnSaveCloud.addEventListener('click', () => {
  // construa a URL do servidor da empresa. Exemplo (ajuste conforme necessÃ¡rio):
  // https://empresa.example.com/save?device=MiniSlave01&v=127.0&i=4.5&fp=0.95
  // NÃƒO enviamos nada automaticamente â€” abrimos apenas a URL em nova aba.
  const params = new URLSearchParams();
  params.set('device', 'MiniSlaveV1'); // se souber id real, passe aqui
  // inclui as Ãºltimas leituras visÃ­veis na UI (opcional)
  try {
    params.set('v', document.getElementById('v').textContent);
    params.set('i', document.getElementById('i').textContent);
    params.set('fp', document.getElementById('fp').textContent);
  } catch {}
  const url = 'https://empresa.exemplo.com/save?' + params.toString(); // ALTERE para o servidor real
  window.open(url, '_blank'); // abre nova aba
});

/* Limpeza quando sair da pÃ¡gina */
window.addEventListener('beforeunload', () => {
  if (httpTimer) clearInterval(httpTimer);
  if (bleChar && bleChar.properties && bleChar.properties.notify) {
    try { bleChar.stopNotifications(); } catch {}
  }
});
</script>
</body>
</html>

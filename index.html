<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BlackBox Mini - Dashboard</title>
<style>
:root{--bg:#0f172a;--card:#1e293b;--txt:#e5e7eb;--muted:#94a3b8;--accent:#38bdf8}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--txt)}
header{background:var(--card);padding:12px;text-align:center;font-size:20px;font-weight:700;color:var(--accent)}
main{padding:16px;max-width:1000px;margin:0 auto}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
.card{background:var(--card);padding:12px;border-radius:10px;display:flex;flex-direction:column;gap:8px}
.label{color:var(--muted);font-size:13px}.valor{color:var(--accent);font-weight:700;font-size:18px}
.controls{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap}
button,input{padding:10px;border-radius:8px;border:none;font-size:14px}
button{background:var(--accent);color:#002233;cursor:pointer}
.small{color:var(--muted);font-size:13px}
.footer{margin-top:14px;color:var(--muted);text-align:center}
.badge{display:inline-block;background:#0b1220;border:1px solid #22314d;color:var(--muted);padding:4px 8px;border-radius:999px;font-size:12px}
.row{display:flex;gap:8px;flex-wrap:wrap}
.status{font-size:13px;color:var(--muted)}
hr{border:0;border-top:1px solid #22314d;margin:10px 0}
</style>
</head>
<body>
<header>ðŸ“Š BlackBox Mini â€” Dashboard</header>
<main>

  <!-- CONEXÃƒO -->
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div>
        <strong>ConexÃ£o</strong>
        <div class="small">BLE recomendado (HTTPS). HTTP como fallback.</div>
        <div id="connStatus" class="status">Aguardandoâ€¦</div>
      </div>
      <div class="row">
        <button id="btnBle">Conectar via BLE</button>
        <button id="btnDisconnect" disabled>Desconectar</button>
      </div>
    </div>

    <hr>

    <div class="row">
      <input id="ipField" placeholder="IP do ESP (ex.: 192.168.4.1)" style="flex:1;min-width:240px">
      <button id="btnHttp">Conectar HTTP</button>
      <span class="badge" id="httpInfo">HTTPS bloqueia chamadas HTTP â€” use BLE no Pages</span>
    </div>

    <div class="row">
      <input id="idField" placeholder="ID do dispositivo (para buscar IP na nuvem)" style="flex:1;min-width:240px">
      <button id="btnFromCloud">Ir via nuvem</button>
    </div>
    <div class="small" id="cloudNote">Configure sua URL de nuvem no cÃ³digo (CLOUD_BASE).</div>
  </div>

  <h2 style="color:var(--accent);margin-top:12px">MediÃ§Ãµes (tempo real)</h2>
  <div class="grid" id="cards">
    <div class="card"><div class="label">TensÃ£o RMS</div><div class="valor" id="v">--</div></div>
    <div class="card"><div class="label">Corrente RMS</div><div class="valor" id="i">--</div></div>
    <div class="card"><div class="label">Fator de PotÃªncia</div><div class="valor" id="fp">--</div></div>
    <div class="card"><div class="label">Ã‚ngulo Ï†</div><div class="valor" id="angle">--</div></div>
    <div class="card"><div class="label">THD TensÃ£o</div><div class="valor" id="thd">--</div></div>
    <div class="card"><div class="label">THD Corrente</div><div class="valor" id="thd_i">--</div></div>
    <div class="card"><div class="label">FrequÃªncia</div><div class="valor" id="f">--</div></div>
    <div class="card"><div class="label">HarmÃ´nico 3Âª</div><div class="valor" id="h3">--</div></div>
    <div class="card"><div class="label">HarmÃ´nico 5Âª</div><div class="valor" id="h5">--</div></div>
    <div class="card"><div class="label">HarmÃ´nico 7Âª</div><div class="valor" id="h7">--</div></div>
  </div>

  <div class="card" style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
    <div>
      <div class="small">Ãšltima atualizaÃ§Ã£o:</div>
      <div id="last" class="small">--</div>
    </div>
    <div class="row">
      <button id="btnSaveCloud">Salvar no servidor (empresa)</button>
    </div>
  </div>

  <div class="footer small">Nada Ã© salvo localmente. Use BLE no GitHub Pages; HTTP funciona quando a pÃ¡gina Ã© aberta em HTTP.</div>
</main>

<script>
/* ===================== CONFIG ===================== */
const SERVICE_UUID   = '12345678-1234-1234-1234-1234567890ab';
const DATA_CHAR_UUID = 'fedcba98-7654-4321-aaaa-bbbbbbbbbbbb';
const CLOUD_BASE     = 'https://SEU_FIREBASE.firebaseio.com/devices';

const el = id => document.getElementById(id);
const connStatus = el('connStatus');
const ipField = el('ipField');
const idField = el('idField');
const btnHttp = el('btnHttp');
const btnFromCloud = el('btnFromCloud');
const btnBle = el('btnBle');
const btnDisconnect = el('btnDisconnect');
const lastEl = el('last');
const btnSaveCloud = el('btnSaveCloud');
const httpInfo = el('httpInfo');

let httpTimer=null, bleDevice=null, bleChar=null;

/* ===================== HELPERS ===================== */
function setStatus(s){ connStatus.textContent=s; }
function updateValues(j){
  if(j.v!==undefined) el('v').textContent=j.v.toFixed(2);
  if(j.i!==undefined) el('i').textContent=j.i.toFixed(2);
  if(j.fp!==undefined) el('fp').textContent=j.fp.toFixed(3);
  if(j.angle!==undefined) el('angle').textContent=j.angle.toFixed(1);
  if(j.thd!==undefined) el('thd').textContent=j.thd.toFixed(2);
  if(j.thd_i!==undefined) el('thd_i').textContent=j.thd_i.toFixed(2);
  if(j.f!==undefined) el('f').textContent=j.f.toFixed(2);
  if(j.h3!==undefined) el('h3').textContent=j.h3.toFixed(2);
  if(j.h5!==undefined) el('h5').textContent=j.h5.toFixed(2);
  if(j.h7!==undefined) el('h7').textContent=j.h7.toFixed(2);
  lastEl.textContent=new Date().toLocaleTimeString();
}

/* ===================== HTTP ===================== */
async function connectHTTPOnce(ip){
  try{
    const r=await fetch(`http://${ip}/data`,{cache:'no-store'});
    const j=await r.json(); updateValues(j);
    setStatus('Conectado via HTTP: '+ip);
  }catch(err){
    console.warn(err); setStatus('Falha HTTP.'); 
  }
}
btnHttp.addEventListener('click',()=>{
  const ip=ipField.value.trim(); if(!ip) return;
  if(httpTimer) clearInterval(httpTimer);
  connectHTTPOnce(ip);
  httpTimer=setInterval(()=>connectHTTPOnce(ip),1000);
});

/* ===================== CLOUD LOOKUP ===================== */
async function resolveIpFromCloud(id){
  const r=await fetch(`${CLOUD_BASE}/${id}.json`); const j=await r.json();
  if(!j||!j.ip) throw new Error('ID nÃ£o encontrado'); return j.ip;
}
btnFromCloud.addEventListener('click',async()=>{
  try{ const ip=await resolveIpFromCloud(idField.value.trim());
    location.href=`http://${ip}`; }catch(err){alert(err);}
});

/* ===================== AUTO ?ip / ?id ===================== */
(function(){
  const q=new URLSearchParams(location.search);
  if(q.get('ip')){ ipField.value=q.get('ip'); btnHttp.click(); }
  if(q.get('id')){ idField.value=q.get('id'); btnFromCloud.click(); }
})();
</script>
</body>
</html>
